
#include <stdio.h>
#include <string>
#include <vector>
#include <Windows.h>
#include <assert.h>
#include "blowfish.h"

using std::vector;
using std::string;

#define GAMENUM 7
#define Z_OK 0

static const char USAGE [] = 
    "Musica\n"
    "Usage: Musica.exe <index> <PackageName> [OutputDirectory]\n  Support index list:\n"
    "    1) ef - the first tale.\n    2) ef - the latter tale.\n    3) eden*\n"
    "    4) 天使の日曜日 “ef - a fairy tale of the two.” Pleasurable Box\n"
    "    5) すぴぱら STORY ＃01 - Spring Has Come！\n    6) 12の月のイヴ\n    7) ましろ色シンフォニ`\n";

typedef int (*UNCOM)(unsigned char *uncompr, unsigned long *puncomprLen, unsigned char *compr, unsigned long comprLen);
UNCOM uncompress;

char OutputDirectory[MAX_PATH];

static const DWORD DecryptTable[256] = {
    0x00000000, 0x77073096, 0xEE0E612C, 0x990951BA, 0x076DC419, 0x706AF48F, 0xE963A535, 0x9E6495A3, 0x0EDB8832, 0x79DCB8A4, 
    0xE0D5E91E, 0x97D2D988, 0x09B64C2B, 0x7EB17CBD, 0xE7B82D07, 0x90BF1D91, 0x1DB71064, 0x6AB020F2, 0xF3B97148, 0x84BE41DE, 
    0x1ADAD47D, 0x6DDDE4EB, 0xF4D4B551, 0x83D385C7, 0x136C9856, 0x646BA8C0, 0xFD62F97A, 0x8A65C9EC, 0x14015C4F, 0x63066CD9, 
    0xFA0F3D63, 0x8D080DF5, 0x3B6E20C8, 0x4C69105E, 0xD56041E4, 0xA2677172, 0x3C03E4D1, 0x4B04D447, 0xD20D85FD, 0xA50AB56B, 
    0x35B5A8FA, 0x42B2986C, 0xDBBBC9D6, 0xACBCF940, 0x32D86CE3, 0x45DF5C75, 0xDCD60DCF, 0xABD13D59, 0x26D930AC, 0x51DE003A, 
    0xC8D75180, 0xBFD06116, 0x21B4F4B5, 0x56B3C423, 0xCFBA9599, 0xB8BDA50F, 0x2802B89E, 0x5F058808, 0xC60CD9B2, 0xB10BE924, 
    0x2F6F7C87, 0x58684C11, 0xC1611DAB, 0xB6662D3D, 0x76DC4190, 0x01DB7106, 0x98D220BC, 0xEFD5102A, 0x71B18589, 0x06B6B51F, 
    0x9FBFE4A5, 0xE8B8D433, 0x7807C9A2, 0x0F00F934, 0x9609A88E, 0xE10E9818, 0x7F6A0DBB, 0x086D3D2D, 0x91646C97, 0xE6635C01, 
    0x6B6B51F4, 0x1C6C6162, 0x856530D8, 0xF262004E, 0x6C0695ED, 0x1B01A57B, 0x8208F4C1, 0xF50FC457, 0x65B0D9C6, 0x12B7E950, 
    0x8BBEB8EA, 0xFCB9887C, 0x62DD1DDF, 0x15DA2D49, 0x8CD37CF3, 0xFBD44C65, 0x4DB26158, 0x3AB551CE, 0xA3BC0074, 0xD4BB30E2, 
    0x4ADFA541, 0x3DD895D7, 0xA4D1C46D, 0xD3D6F4FB, 0x4369E96A, 0x346ED9FC, 0xAD678846, 0xDA60B8D0, 0x44042D73, 0x33031DE5, 
    0xAA0A4C5F, 0xDD0D7CC9, 0x5005713C, 0x270241AA, 0xBE0B1010, 0xC90C2086, 0x5768B525, 0x206F85B3, 0xB966D409, 0xCE61E49F, 
    0x5EDEF90E, 0x29D9C998, 0xB0D09822, 0xC7D7A8B4, 0x59B33D17, 0x2EB40D81, 0xB7BD5C3B, 0xC0BA6CAD, 0xEDB88320, 0x9ABFB3B6, 
    0x03B6E20C, 0x74B1D29A, 0xEAD54739, 0x9DD277AF, 0x04DB2615, 0x73DC1683, 0xE3630B12, 0x94643B84, 0x0D6D6A3E, 0x7A6A5AA8, 
    0xE40ECF0B, 0x9309FF9D, 0x0A00AE27, 0x7D079EB1, 0xF00F9344, 0x8708A3D2, 0x1E01F268, 0x6906C2FE, 0xF762575D, 0x806567CB, 
    0x196C3671, 0x6E6B06E7, 0xFED41B76, 0x89D32BE0, 0x10DA7A5A, 0x67DD4ACC, 0xF9B9DF6F, 0x8EBEEFF9, 0x17B7BE43, 0x60B08ED5, 
    0xD6D6A3E8, 0xA1D1937E, 0x38D8C2C4, 0x4FDFF252, 0xD1BB67F1, 0xA6BC5767, 0x3FB506DD, 0x48B2364B, 0xD80D2BDA, 0xAF0A1B4C, 
    0x36034AF6, 0x41047A60, 0xDF60EFC3, 0xA867DF55, 0x316E8EEF, 0x4669BE79, 0xCB61B38C, 0xBC66831A, 0x256FD2A0, 0x5268E236, 
    0xCC0C7795, 0xBB0B4703, 0x220216B9, 0x5505262F, 0xC5BA3BBE, 0xB2BD0B28, 0x2BB45A92, 0x5CB36A04, 0xC2D7FFA7, 0xB5D0CF31, 
    0x2CD99E8B, 0x5BDEAE1D, 0x9B64C2B0, 0xEC63F226, 0x756AA39C, 0x026D930A, 0x9C0906A9, 0xEB0E363F, 0x72076785, 0x05005713, 
    0x95BF4A82, 0xE2B87A14, 0x7BB12BAE, 0x0CB61B38, 0x92D28E9B, 0xE5D5BE0D, 0x7CDCEFB7, 0x0BDBDF21, 0x86D3D2D4, 0xF1D4E242, 
    0x68DDB3F8, 0x1FDA836E, 0x81BE16CD, 0xF6B9265B, 0x6FB077E1, 0x18B74777, 0x88085AE6, 0xFF0F6A70, 0x66063BCA, 0x11010B5C, 
    0x8F659EFF, 0xF862AE69, 0x616BFFD3, 0x166CCF45, 0xA00AE278, 0xD70DD2EE, 0x4E048354, 0x3903B3C2, 0xA7672661, 0xD06016F7, 
    0x4969474D, 0x3E6E77DB, 0xAED16A4A, 0xD9D65ADC, 0x40DF0B66, 0x37D83BF0, 0xA9BCAE53, 0xDEBB9EC5, 0x47B2CF7F, 0x30B5FFE9, 
    0xBDBDF21C, 0xCABAC28A, 0x53B39330, 0x24B4A3A6, 0xBAD03605, 0xCDD70693, 0x54DE5729, 0x23D967BF, 0xB3667A2E, 0xC4614AB8, 
    0x5D681B02, 0x2A6F2B94, 0xB40BBE37, 0xC30C8EA1, 0x5A05DF1B, 0x2D02EF8D,
};

// 封包中的数据结构
#pragma pack(1)
typedef struct
{
    BYTE Byte[32];
} PAZHEADER;

typedef struct
{
    char  *Name;
    LARGE_INTEGER Offset;
    DWORD  ComprLen;
    DWORD  UncomprLen;
    DWORD  AlignPkgLen;
    WORD   IsCompressed;    // 0: 未压缩, 1: zlib
    WORD   Reserved;
} PAZENTRY, *PPAZENTRY;
#pragma pack()


typedef struct
{
    char   Name[MAX_PATH];
    LARGE_INTEGER Offset;
    DWORD  UncomprLen;
    DWORD  ComprLen;
    DWORD  AlignPkgLen;
    WORD   IsCompressed;
    WORD   Reserved;
} MYPAZENTRY, *PMYPAZENTRY;


typedef struct
{
    char *Name;
    BYTE XorCode;
    enum {
        TYPE_SCR = 0,
        TYPE_PNG,
        TYPE_OGG,
        TYPE_MOV
    };
    int Version;
    vector<HANDLE> PackList;
    char secret[4][16];
    struct PazPackKey *pack;
} GAMEDECRYPTINFO, *PGAMEDECRYPTINFO;


struct PazPackKey
{
    char *PazName;
    int KeyLen;
    PGAMEDECRYPTINFO parent;   // 指向所属游戏的 GAMEDECRYPTINFO
    BYTE Key[2][128];           // 第1个用来解索引, 第2个用来解资源
};

static struct PazPackKey BlowFishKey_ef_latter_Pack[] = {
    {
        "scr.paz", 32, 0,
        {
            {
                0x07, 0x81, 0x2b, 0x53, 0xaf, 0xa3, 0x2b, 0x3b, 0x2d, 0xa8, 0x5a, 0xbb, 0x5c, 0x50, 0x50, 0x8b,
                0xf3, 0xcd, 0xc3, 0x23, 0x84, 0xf4, 0x9f, 0xe8, 0x24, 0xfb, 0x74, 0xa7, 0x46, 0xd9, 0x1b, 0x1b,
            },
            {
                0xd3, 0xe0, 0x5d, 0x33, 0x9f, 0x4e, 0xc7, 0x9d, 0xcb, 0xb4, 0x18, 0xfe, 0xbd, 0xca, 0x7d, 0x1b,
                0x36, 0x45, 0xcd, 0x47, 0x31, 0xe3, 0x2a, 0x2c, 0xf1, 0x04, 0x5a, 0xe5, 0x28, 0x09, 0xab, 0xa0,
            }
        }
    },
    {
        "bg.paz", 32, 0,
        {
            {
                0x1A, 0x59, 0x52, 0xD9, 0x1E, 0xE4, 0xDA, 0x31, 0xCF, 0xC6, 0xA0, 0xA7, 0x94, 0xE5, 0x41, 0xA6,
                0xBD, 0x37, 0xBB, 0xDF, 0xD0, 0xED, 0x4B, 0x3E, 0xAB, 0x8D, 0x4E, 0x1A, 0x9B, 0xF6, 0xC5, 0x8B,
            },
            {
                0x9d, 0xfd, 0xe2, 0x56, 0xe0, 0x70, 0x79, 0x4e, 0x3f, 0x46, 0x8d, 0x49, 0xc6, 0x68, 0x22, 0x32,
                0x00, 0x2d, 0x7b, 0x0a, 0x47, 0x2c, 0x90, 0x17, 0x9b, 0x44, 0x0b, 0x61, 0xe1, 0xd9, 0x98, 0x1f,
            }
        }
    },
    {
        "st.paz", 32, 0,
        {
            {
                0x09, 0x55, 0x97, 0x79, 0xd4, 0xe7, 0x0d, 0x93, 0x02, 0xe1, 0x9c, 0x47, 0x97, 0x81, 0xb5, 0x50,
                0xae, 0x9a, 0x56, 0xde, 0xfc, 0x83, 0xe7, 0x4d, 0xfd, 0x71, 0xbe, 0x14, 0xfd, 0x27, 0x9b, 0xe1,
            },
            {
                0xa2, 0xcc, 0xd4, 0xf8, 0xb6, 0xf7, 0xc9, 0x2f, 0x91, 0x28, 0xe1, 0x2d, 0x91, 0x8f, 0x71, 0xc7,
                0x75, 0x01, 0x04, 0x47, 0xc8, 0x26, 0x2f, 0x3a, 0xe7, 0x9d, 0x06, 0xda, 0x32, 0x16, 0xf6, 0x1e,
            }
        }
    },
    {
        "sys.paz", 32, 0,
        {
            {
                0xdf, 0x74, 0xcf, 0x44, 0x3a, 0xd5, 0x54, 0x0e, 0xb9, 0x09, 0x52, 0xe4, 0x0f, 0xb0, 0x88, 0x83,
                0x0a, 0x40, 0x26, 0x06, 0x2e, 0xa0, 0x66, 0x56, 0x51, 0xc9, 0x16, 0x54, 0xd1, 0xdb, 0xe5, 0xc3,
            },
            {
                0x7a, 0x87, 0x77, 0x86, 0x8f, 0xb0, 0xa2, 0xc3, 0x9e, 0xcd, 0x85, 0x16, 0xa3, 0x06, 0xf3, 0xd1,
                0x58, 0x23, 0x57, 0xb4, 0x34, 0x90, 0xed, 0x41, 0xf0, 0x5f, 0x40, 0xb8, 0x3b, 0x0c, 0x81, 0x1c,
            }
        }
    },
    {
        "bgm.paz", 32, 0,
        {
            {
                0xfc, 0xa7, 0x93, 0x36, 0x69, 0x34, 0x61, 0x41, 0x0f, 0x10, 0x88, 0xba, 0x11, 0x9e, 0x50, 0x3e,
                0xc8, 0x5f, 0x91, 0x89, 0xb4, 0xa2, 0x7e, 0x67, 0x33, 0xa5, 0x5d, 0x2f, 0xa0, 0x07, 0xf7, 0x9a,
            },
            {
                0x73, 0x84, 0x77, 0x7f, 0x4d, 0xfc, 0x9a, 0x95, 0xf6, 0x0a, 0xe6, 0xcd, 0x50, 0x9a, 0xaf, 0x8f,
                0x5e, 0xda, 0x8d, 0x02, 0x12, 0x0a, 0x6c, 0xb7, 0x40, 0xc5, 0x23, 0xf5, 0x07, 0x40, 0x28, 0x58,
            }
        }
    },
    {
        "voice.paz", 32, 0,
        {
            {
                0x00, 0x95, 0xfe, 0xf8, 0x45, 0x42, 0x0d, 0xcb, 0xff, 0x3f, 0x56, 0x01, 0x17, 0xd4, 0x26, 0x32,
                0xd1, 0x2c, 0x70, 0xa7, 0xfe, 0x0d, 0xb8, 0xc4, 0x4d, 0xa2, 0x63, 0x97, 0x6e, 0xed, 0xe2, 0x27,
            },
            {
                0x7d, 0xa1, 0x2b, 0xe2, 0x3c, 0x15, 0x3d, 0x2d, 0x10, 0x7c, 0x22, 0xa4, 0x73, 0x69, 0x05, 0x4a,
                0xa0, 0x18, 0xa0, 0x3c, 0xf5, 0x83, 0xea, 0x85, 0x22, 0xae, 0x9b, 0x3b, 0x63, 0xef, 0xf8, 0xaf,
            }
        }
    },
    {
        "se.paz", 32, 0,
        {
            {
                0xd2, 0x30, 0xe2, 0xec, 0xbb, 0x90, 0x2a, 0x53, 0xab, 0x1d, 0xa5, 0xe6, 0xf5, 0xb4, 0xd9, 0x62,
                0xee, 0xb6, 0x6e, 0x83, 0xfa, 0x6b, 0xdd, 0x54, 0x86, 0x3c, 0xa5, 0xad, 0x06, 0x01, 0xf1, 0x11,
            },
            {
                0x83, 0x56, 0xe5, 0xb1, 0x83, 0x64, 0x38, 0x7d, 0x97, 0x1c, 0x44, 0xfc, 0x17, 0x34, 0xc2, 0x93,
                0xf3, 0x7a, 0x43, 0x6d, 0x90, 0xf5, 0xce, 0x9e, 0xcd, 0x12, 0x23, 0xf6, 0x79, 0x91, 0x2c, 0x51,
            }
        }
    },
    {
        "mov.paz", 32, 0,
        {
            {
                0xc2, 0xea, 0xff, 0xab, 0x99, 0xce, 0xe2, 0x4b, 0x9a, 0xa5, 0xfd, 0xee, 0x5a, 0xca, 0x77, 0xca,
                0x6a, 0xf3, 0x71, 0x15, 0xd9, 0x14, 0x48, 0x37, 0xd3, 0x22, 0x43, 0xd1, 0xbb, 0x36, 0x72, 0x2f,
            },
            { 0 }
        }
    },
    {0, 0, 0, 0}
};

static struct PazPackKey BlowFishKey_12eve_Pack[] = {
    {
        "bg.paz", 32, 0,
        {
            {
                0xB6, 0x25, 0xB2, 0x4B, 0x5E, 0x0F, 0x97, 0x98, 0xE6, 0x5F, 0x48, 0x57, 0x13, 0xF9, 0x77, 0x4A,
                0x8A, 0xC4, 0x33, 0xBD, 0xC9, 0xEE, 0x16, 0xD2, 0xEA, 0x02, 0xF3, 0xB0, 0x48, 0xA7, 0x09, 0x49,
            },
            {
                0xD6, 0xB8, 0xF1, 0xE0, 0x7E, 0xD5, 0xAB, 0x01, 0x2C, 0xB2, 0x7C, 0x6A, 0x98, 0x60, 0x2E, 0xC3,
                0x1C, 0x2A, 0x9A, 0x84, 0x33, 0x82, 0xC5, 0x39, 0xD0, 0x99, 0x9A, 0x20, 0x3A, 0xA1, 0x6B, 0x5E,
            }
        }
    },
    {
        "bgm.paz", 32, 0,
        {
            {
                0x9F, 0x63, 0xF6, 0x0A, 0x51, 0x81, 0x62, 0xB3, 0xA1, 0xC6, 0xBD, 0x71, 0xB5, 0x98, 0x17, 0x2E,
                0xB6, 0x7D, 0x74, 0xFD, 0x46, 0x29, 0x80, 0xB9, 0x6B, 0x5C, 0x66, 0xEB, 0x86, 0xD9, 0xB2, 0x27,
            },
            {
                0xE1, 0x84, 0xE5, 0x55, 0x16, 0x48, 0xA2, 0x5B, 0x89, 0xA4, 0xC7, 0x58, 0x14, 0xC3, 0x66, 0x9D,
                0x15, 0x3C, 0x84, 0x34, 0x8E, 0x38, 0xAA, 0x06, 0x0B, 0xB7, 0x92, 0x5B, 0xBA, 0x7F, 0xA5, 0xDA,
            }
        }
    },
    {
        "mov.paz", 32, 0,
        {
            {
                0x3B, 0x24, 0x3B, 0xEF, 0x2C, 0x85, 0xC0, 0xD3, 0xB9, 0x6B, 0x9D, 0xF8, 0xBD, 0xA7, 0xA3, 0xD2,
                0x74, 0x99, 0x10, 0xFC, 0x60, 0xE1, 0xAB, 0x06, 0xE8, 0xBE, 0xF1, 0x02, 0x7F, 0xF8, 0xCA, 0xB2,
            },
            {
                0xCE, 0x24, 0x53, 0xA0, 0x03, 0x99, 0x05, 0x6B, 0x9A, 0xDB, 0x43, 0x21, 0xAB, 0x50, 0xC9, 0xAA,
                0x56, 0x9A, 0x8E, 0x2C, 0x9D, 0x1F, 0x79, 0xB4, 0xBC, 0xF9, 0x81, 0xCC, 0x8B, 0xC2, 0x07, 0x85,
            }
        }
    },
    {
        "scr.paz", 32, 0,
        {
            {
                0x09, 0x92, 0x5D, 0x58, 0x0B, 0x5B, 0xB3, 0x25, 0x58, 0xB4, 0xA3, 0x2F, 0x9B, 0x67, 0xF0, 0x38,
                0x8B, 0xDA, 0x05, 0x9F, 0x02, 0x3B, 0xE4, 0xF4, 0x55, 0xA5, 0x88, 0xCA, 0x78, 0x38, 0xE8, 0x0E,
            },
            {
                0x29, 0x33, 0x58, 0x08, 0xE2, 0x63, 0x0B, 0xEB, 0xC7, 0xC3, 0xDC, 0x6B, 0x9E, 0xA8, 0x4E, 0x1E,
                0xFF, 0xC7, 0x6E, 0xB2, 0x13, 0xFB, 0x98, 0x4C, 0x4A, 0x32, 0xF2, 0xAF, 0x9C, 0x52, 0x0C, 0xD9,
            }
        }
    },
    {
        "se.paz", 32, 0,
        {
            {
                0xC6, 0x48, 0xF4, 0x1B, 0x8B, 0xEF, 0xAB, 0x90, 0x90, 0x83, 0xE0, 0x86, 0x12, 0xDB, 0xFF, 0xF2,
                0xB6, 0x27, 0x92, 0xC1, 0xD9, 0xE8, 0x1F, 0x4B, 0x5D, 0xE2, 0x55, 0x8B, 0x85, 0x7D, 0x9D, 0xDC,
            },
            {
                0x9F, 0xF0, 0x03, 0x29, 0xCD, 0x5C, 0x7E, 0xED, 0x67, 0x2B, 0x9E, 0x53, 0x05, 0x58, 0x89, 0x87,
                0x84, 0x2E, 0x0B, 0xDE, 0xD0, 0xD2, 0x9E, 0xB8, 0xE6, 0x6C, 0xD2, 0x33, 0xF9, 0xA5, 0x83, 0xBF,
            }
        }
    },
    {
        "st.paz", 32, 0,
        {
            {
                0xF4, 0x73, 0xFC, 0xC0, 0x30, 0xB8, 0xA7, 0xE0, 0x78, 0xD6, 0x96, 0x01, 0x3C, 0x40, 0x76, 0xCC,
                0x99, 0xE9, 0xF6, 0xE2, 0x66, 0x13, 0xFD, 0x95, 0xEF, 0x24, 0x35, 0x8C, 0xA3, 0xD8, 0xBB, 0x91,
            },
            {
                0x2D, 0xF8, 0x19, 0x78, 0x98, 0x3D, 0xF7, 0x2E, 0x68, 0x96, 0x08, 0x42, 0xB2, 0x4F, 0xD9, 0xB7,
                0x26, 0xDC, 0xF5, 0xEF, 0x24, 0xDD, 0xEF, 0xDE, 0xD0, 0xD6, 0xFC, 0xC5, 0xFB, 0x18, 0xD2, 0xC3,
            }
        }
    },
    {
        "sys.paz", 32, 0,
        {
            {
                0x60, 0xF0, 0x21, 0x0F, 0x0E, 0xAF, 0xC3, 0x3A, 0x8F, 0xA7, 0x72, 0xE5, 0x38, 0x66, 0x74, 0xA8,
                0x1A, 0x3E, 0x5C, 0x1C, 0xDE, 0xE4, 0x28, 0x1B, 0x9E, 0x9F, 0x8F, 0x06, 0x2E, 0xEF, 0x91, 0x1E,
            },
            {
                0xE0, 0x66, 0x45, 0xB3, 0x08, 0xFB, 0xCD, 0xF6, 0x89, 0xF3, 0xF9, 0xCA, 0x9E, 0x79, 0x6B, 0xBD,
                0x71, 0x9F, 0x15, 0xB1, 0x6A, 0xDA, 0x53, 0xDD, 0xF6, 0xEF, 0x4D, 0x2F, 0x09, 0xFE, 0x9A, 0x01,
            }
        }
    },
    {
        "voice.paz", 32, 0,
        {
            {
                0xF8, 0x77, 0xEF, 0xD4, 0xAE, 0x72, 0x9F, 0xD8, 0x75, 0x5B, 0x1A, 0xC8, 0x6E, 0x9D, 0x1D, 0x40,
                0xCE, 0x11, 0xD5, 0xAF, 0xDA, 0x2D, 0x47, 0x0F, 0xBB, 0xFE, 0x10, 0x64, 0x05, 0x57, 0xC7, 0xCD,
            },
            {
                0x0C, 0x7E, 0xAD, 0xDB, 0x83, 0xE8, 0xD4, 0x20, 0x6C, 0x11, 0x8B, 0x9F, 0x2D, 0x23, 0xB9, 0x90,
                0xF7, 0x1E, 0x7E, 0x85, 0x15, 0x0E, 0xEA, 0x9E, 0x2A, 0x03, 0x27, 0x3F, 0x19, 0x77, 0xBA, 0xE9,
            }
        }
    },
    {0, 0, 0, 0}
};

static struct PazPackKey BlowFishKey_sppl1_Pack[] = {
    {
        "scr.paz", 32, 0,       // scr_cn.paz
        {
            {
                0xC1, 0x95, 0x2D, 0xEB, 0x1F, 0xEA, 0xE8, 0x94, 0xEA, 0x3B, 0xE0, 0x27, 0x9D, 0xB3, 0x97, 0x57,
                0x9A, 0x17, 0xCE, 0xDD, 0x2F, 0xFD, 0xD3, 0xCD, 0xC5, 0x8E, 0x27, 0x36, 0xFF, 0xAA, 0x63, 0x3E,
            },
            {
                0x99, 0xC0, 0x64, 0x66, 0xD6, 0xA7, 0x55, 0x37, 0x03, 0x2E, 0x89, 0xAB, 0x38, 0xCE, 0x13, 0xDF,
                0xF9, 0x58, 0x0B, 0x4F, 0xA1, 0x3C, 0x04, 0x07, 0xF5, 0x90, 0x85, 0xA1, 0x30, 0xB5, 0x6E, 0x08,
            }
        }
    },
    {
        "bg.paz", 32, 0,
        {
            {
                0xC2, 0x12, 0x18, 0x17, 0xF3, 0x6C, 0x56, 0x4A, 0x56, 0xEA, 0xD9, 0x7D, 0xF0, 0x81, 0x9F, 0x87,
                0xFB, 0x54, 0x71, 0x76, 0x66, 0x11, 0x3D, 0x74, 0xFB, 0x4A, 0x59, 0x5F, 0x2A, 0xB6, 0xDF, 0xD9,
            },
            {
                0xBC, 0xD8, 0xBC, 0x36, 0x10, 0xBA, 0x94, 0x99, 0x9F, 0xCD, 0xF0, 0x0F, 0x97, 0x70, 0x27, 0xDB,
                0x75, 0x48, 0x02, 0xFB, 0x1C, 0xE3, 0x06, 0xEE, 0xCC, 0x2D, 0x52, 0x2B, 0x06, 0x5B, 0x0A, 0xEB,
            }
        }
    },
    {
        "st.paz", 32, 0,
        {
            {
                0x69, 0xD1, 0xCE, 0x9B, 0xB9, 0xB1, 0x26, 0xE3, 0x81, 0xD8, 0x6A, 0xED, 0xAA, 0x70, 0x8F, 0x94,
                0xEB, 0x88, 0x77, 0xBF, 0x26, 0x1D, 0xCE, 0x34, 0xF5, 0x5F, 0xAF, 0x38, 0x79, 0xEE, 0x42, 0x7E,
            },
            {
                0xC7, 0x81, 0x64, 0x52, 0x20, 0xE1, 0x0A, 0x86, 0x09, 0xF5, 0x54, 0x8F, 0x85, 0x56, 0xEC, 0x30,
                0x32, 0xF3, 0x59, 0x44, 0x51, 0x3B, 0x31, 0xC6, 0x6E, 0x95, 0x06, 0xBA, 0xBF, 0x7A, 0x56, 0x73,
            }
        }
    },
    {
        "sys.paz", 32, 0,
        {
            {
                0x24, 0xD2, 0x5F, 0x16, 0x00, 0x02, 0x59, 0xC4, 0x35, 0xF0, 0x18, 0x93, 0x3B, 0x91, 0x32, 0x50,
                0xDA, 0x57, 0x3D, 0xE4, 0x1E, 0xCF, 0xA5, 0x05, 0xA4, 0x71, 0x91, 0x2A, 0x69, 0xC5, 0x72, 0x7D,
            },
            {
                0x1A, 0x51, 0xFD, 0xC1, 0x4C, 0xE7, 0xE2, 0x46, 0xA6, 0xFA, 0x90, 0x62, 0x49, 0x03, 0xB8, 0xD7,
                0xE9, 0x20, 0x73, 0x1A, 0x90, 0x39, 0x1B, 0x4B, 0x48, 0xDE, 0xDC, 0x3E, 0x38, 0x0D, 0x59, 0x91,
            }
        }
    },
    {
        "bgm.paz", 32, 0,
        {
            {
                0x20, 0x1D, 0x5F, 0x5D, 0xC8, 0x06, 0x4A, 0x84, 0x20, 0xB5, 0xF7, 0x29, 0x6E, 0xE7, 0x4F, 0x8A,
                0xEF, 0x34, 0x66, 0x95, 0x3D, 0xFA, 0x2F, 0xFF, 0x48, 0x5A, 0xD2, 0x4E, 0x80, 0xD1, 0x30, 0x97,
            },
            {
                0x1A, 0x97, 0x88, 0x6D, 0x49, 0xE8, 0xB0, 0x04, 0xD8, 0x4E, 0x75, 0xBD, 0x5C, 0x4D, 0x22, 0x88,
                0x68, 0xDB, 0x88, 0xB3, 0xB1, 0x96, 0x88, 0x86, 0xCC, 0xBF, 0xB0, 0x1C, 0x94, 0xCF, 0x81, 0x8D,
            }
        }
    },
    {
        "voice.paz", 32, 0,
        {
            {
                0x8E, 0x11, 0x21, 0xAC, 0xD2, 0x33, 0x99, 0xD4, 0x5F, 0x21, 0x10, 0xA3, 0xE1, 0x8B, 0xC1, 0x5D,
                0xC4, 0xC1, 0xD9, 0xF6, 0x67, 0x1F, 0x6F, 0x64, 0x37, 0x63, 0x03, 0x10, 0x7A, 0x06, 0x4D, 0x18,
            },
            {
                0x6A, 0xC6, 0x6A, 0xB1, 0x07, 0x88, 0xB6, 0x9B, 0x83, 0x7A, 0xDF, 0x6E, 0x64, 0xEB, 0xFE, 0x08,
                0xCD, 0x67, 0xDA, 0x0F, 0x1D, 0xC7, 0x6A, 0x59, 0x6D, 0xA1, 0x21, 0x5A, 0xAD, 0x01, 0x5F, 0x5C,
            }
        }
    },
    {
        "se.paz", 32, 0,
        {
            {
                0x22, 0xBA, 0x67, 0x28, 0xF5, 0x08, 0x14, 0xA8, 0x70, 0x48, 0x8B, 0xD4, 0x5A, 0x75, 0x94, 0x6C,
                0xB9, 0xB6, 0x14, 0x29, 0xE2, 0x0B, 0x24, 0x68, 0x66, 0x99, 0x3A, 0xEC, 0xEC, 0x28, 0xBA, 0xF6,
            },
            {
                0xA6, 0x5C, 0x9A, 0x91, 0x52, 0x80, 0x18, 0x51, 0x19, 0xF4, 0x40, 0x56, 0x7F, 0x0B, 0xDE, 0x1F,
                0x38, 0x9F, 0x32, 0x82, 0xF5, 0xF6, 0x4E, 0x50, 0x92, 0x3A, 0x7F, 0xAB, 0x10, 0x1E, 0xF8, 0xCC,
            }
        }
    },
    {
        "mov.paz", 32, 0,
        {
            {
                0xF0, 0xD4, 0x32, 0xC2, 0x49, 0x4A, 0x97, 0xB5, 0x2F, 0x53, 0x42, 0x3A, 0x2A, 0x8B, 0xDC, 0xA3,
                0x9C, 0xC6, 0xCE, 0x60, 0x21, 0xE8, 0x57, 0xDE, 0x57, 0xAE, 0xBA, 0x75, 0xDC, 0x6E, 0xDB, 0x46,
            },
            {
                
            }
        }
    },
    {0, 0, 0, 0}
};

static struct PazPackKey BlowFishKey_effd_Pack[] = {    // 这里对应的是galstars. 音羽教会的汉化硬盘版，原版下好了再替换
    {
        "bg_sc.paz", 32, 0,
        {
            {
                0x2C, 0x4C, 0x16, 0x48, 0x48, 0xC2, 0xD2, 0x5E, 0x2C, 0x41, 0x2C, 0x07, 0x8B, 0xEE, 0xFE, 0x37,
                0xF9, 0x21, 0x2D, 0x70, 0xE5, 0xB2, 0x4E, 0x77, 0xDF, 0x61, 0xC7, 0xCC, 0x32, 0x45, 0xD0, 0x0A,
            },
            {
                0x65, 0x67, 0xAE, 0xB6, 0x3C, 0x56, 0x48, 0x97, 0x6E, 0x57, 0xA3, 0x57, 0xAC, 0xBB, 0xB9, 0x01,
                0x3C, 0xAC, 0x7D, 0x00, 0x0C, 0x43, 0x3E, 0x80, 0xF1, 0x61, 0xAC, 0x4B, 0x1F, 0x3B, 0xF8, 0x1E,
            }
        }
    },
    {
        "bgm.paz", 32, 0,
        {
            {
                0x16, 0x57, 0x1D, 0xD4, 0x4D, 0x61, 0x69, 0x8C, 0xEF, 0x5A, 0x93, 0xF1, 0x10, 0xD6, 0x51, 0x8D,
                0xBC, 0x9E, 0x29, 0x9E, 0xAE, 0x0E, 0xA2, 0x06, 0xF5, 0x95, 0x6D, 0xCC, 0x22, 0x16, 0x7C, 0xE8,
            },
            {
                0xA1, 0x75, 0xE8, 0xA4, 0x21, 0xD2, 0x68, 0xB9, 0x61, 0x16, 0x3A, 0x21, 0xD3, 0x17, 0xFF, 0xB8,
                0x96, 0x51, 0xFB, 0xBB, 0xC2, 0x93, 0x0A, 0xF8, 0xA7, 0xFB, 0xE9, 0xED, 0x17, 0xDF, 0x12, 0x63,
            }
        }
    },
    {
        "mov_sc.paz", 32, 0,
        {
            {
                0x2D, 0xCB, 0x3B, 0xA8, 0x92, 0x3F, 0x60, 0x86, 0xCD, 0xE2, 0xB5, 0x25, 0xB0, 0x82, 0xA5, 0x48,
                0x2F, 0xE0, 0xB4, 0x5E, 0x43, 0xB7, 0x2A, 0x08, 0x43, 0x62, 0x9C, 0x88, 0xC1, 0x04, 0x04, 0xA5,
            },
            {
                
            }
        }
    },
    {
        "scr_sc.paz", 32, 0,
        {
            {
                0xBB, 0xD7, 0xC8, 0x5C, 0x03, 0x53, 0x4D, 0x81, 0x33, 0x8E, 0xA4, 0x2B, 0x60, 0x51, 0x5D, 0x01,
                0x27, 0x38, 0x1D, 0xC5, 0x99, 0xAA, 0x44, 0xF3, 0xBF, 0xE6, 0xA2, 0x04, 0x38, 0xF4, 0xAF, 0xD0,
            },
            {
                0xF5, 0x9A, 0x43, 0xB2, 0x4E, 0xA6, 0xC2, 0xDB, 0x51, 0xB3, 0xBE, 0xBC, 0x09, 0x3C, 0x12, 0xCE,
                0x5D, 0x86, 0xAD, 0x46, 0x81, 0x7B, 0xA0, 0xFE, 0x2C, 0x1D, 0x90, 0x0D, 0x53, 0x92, 0x77, 0x1C,
            }
        }
    },
    {
        "se.paz", 32, 0,
        {
            {
                0x36, 0x5E, 0x32, 0xD5, 0x4F, 0xA8, 0x07, 0x8B, 0xF0, 0xBA, 0x1A, 0x27, 0xBF, 0x8A, 0xFA, 0xF6,
                0x52, 0x9C, 0x8B, 0x80, 0x91, 0x96, 0xDE, 0x73, 0x8A, 0x41, 0xF4, 0x4A, 0xF2, 0x94, 0x0B, 0xA6,
            },
            {
                0xC7, 0x3E, 0xBB, 0x19, 0x6B, 0x60, 0xC8, 0xDE, 0xEB, 0x02, 0x73, 0x0E, 0xA2, 0x23, 0x03, 0xDD,
                0x9C, 0xA5, 0x47, 0x98, 0xE5, 0x17, 0x32, 0x2D, 0x33, 0x66, 0xAC, 0x23, 0x62, 0x6C, 0x76, 0x23,
            }
        }
    },
    {
        "st_sc.paz", 32, 0,
        {
            {
                0x09, 0x10, 0x7C, 0x1A, 0x4B, 0xA4, 0xD6, 0x9D, 0x6E, 0x7E, 0x8D, 0xD0, 0x1F, 0x7F, 0xBA, 0xA7,
                0x27, 0x97, 0xD0, 0x83, 0x7B, 0xA1, 0xEA, 0x8F, 0xE4, 0xF0, 0x30, 0xD7, 0xB4, 0xF6, 0x8B, 0xA6,
            },
            {
                0x84, 0x22, 0x76, 0xAA, 0x64, 0x95, 0x61, 0x01, 0x2A, 0x1A, 0x19, 0x68, 0x40, 0x6C, 0x39, 0x28,
                0x1B, 0x04, 0xDA, 0x01, 0x30, 0x6E, 0xAE, 0x0F, 0xCC, 0x77, 0x67, 0x21, 0xD3, 0x80, 0x55, 0xDE,
            }
        }
    },
    {
        "sys_sc.paz", 32, 0,
        {
            {
                0x89, 0x9E, 0xAD, 0xEE, 0x79, 0x18, 0xE8, 0xD2, 0x2F, 0x91, 0x80, 0xFD, 0xE5, 0xC6, 0x21, 0x59,
                0x51, 0x9E, 0x9E, 0x11, 0x50, 0xC9, 0x8C, 0x4E, 0x3A, 0xEE, 0x04, 0x28, 0x32, 0x38, 0x15, 0xF8,
            },
            {
                0x31, 0xCC, 0x39, 0xBF, 0x27, 0x27, 0xA6, 0xF5, 0x64, 0xF3, 0xD1, 0x44, 0x66, 0xD3, 0x41, 0x80,
                0xF9, 0x29, 0xD3, 0xF0, 0xFB, 0x8B, 0xB0, 0xF4, 0x52, 0xF7, 0x03, 0x2F, 0x97, 0xD0, 0x98, 0x20,
            }
        }
    },
    {
        "voice_sc.paz", 32, 0,
        {
            {
                0xA8, 0x95, 0xEA, 0xF7, 0x3E, 0x93, 0xB8, 0xCD, 0x2D, 0x88, 0x4B, 0x18, 0xB3, 0x30, 0x39, 0xC7,
                0x5F, 0xD8, 0x41, 0x89, 0x61, 0x66, 0xD4, 0xC9, 0x45, 0x1B, 0x4D, 0x93, 0x44, 0xB6, 0x7B, 0xB2,
            },
            {
                0x58, 0xF7, 0x06, 0x47, 0x23, 0x43, 0x2B, 0x65, 0x26, 0xB0, 0xB0, 0x01, 0x01, 0xA0, 0x1F, 0x09,
                0x2F, 0x0C, 0x06, 0x5A, 0xD5, 0xDC, 0x0C, 0x7B, 0xE7, 0x7D, 0xD2, 0x90, 0x52, 0x4E, 0x51, 0x53,
            }
        }
    },
    {0, 0, 0, 0}
};

static struct PazPackKey BlowFishKey_eden_Pack[] = {    // 这里 _sc 对应的是galstars. 音羽教会的汉化硬盘版
    {
        "scr.paz", 32, 0,
        {
            {
                0xF9, 0x6A, 0x95, 0x4A, 0x0B, 0xBB, 0xF0, 0xD7, 0xCC, 0x71, 0xF9, 0x70, 0xF4, 0xAD, 0x83, 0x71,
                0x05, 0xC7, 0x89, 0x1A, 0x42, 0x7B, 0xDB, 0x2E, 0x47, 0x27, 0x8E, 0x4B, 0xAC, 0x59, 0x92, 0xC8,
            },
            {
                0xD7, 0xA4, 0xF4, 0xA2, 0xC9, 0x92, 0xFD, 0xEA, 0x87, 0xDC, 0xD1, 0xAD, 0x15, 0x3E, 0x60, 0x43,
                0xAC, 0xC6, 0x63, 0x6F, 0xCB, 0x76, 0x40, 0x49, 0xDA, 0x11, 0x46, 0x24, 0xDD, 0xC7, 0x86, 0x81,
            }
        }
    },
    {
        "bg.paz", 32, 0,
        {
            {
                0xC8, 0x08, 0x7C, 0x8A, 0x68, 0x26, 0xA2, 0x64, 0xB6, 0x33, 0x89, 0x4C, 0x79, 0x65, 0x78, 0x12,
                0x67, 0x52, 0x13, 0x34, 0x42, 0xF6, 0xEA, 0x11, 0x04, 0x87, 0xA0, 0xC5, 0x97, 0xC2, 0x22, 0x08,
            },
            {
                0x10, 0x77, 0x38, 0x2A, 0x55, 0x69, 0x5D, 0x04, 0x47, 0xDB, 0x2A, 0x2E, 0x61, 0x85, 0xD0, 0x30,
                0x6F, 0xE4, 0x51, 0x61, 0xFD, 0xB7, 0x93, 0x06, 0x5A, 0xC1, 0x85, 0xE1, 0x0E, 0x40, 0x8E, 0x89,
            }
        }
    },
    {
        "bgm.paz", 32, 0,
        {
            {
                0xFA, 0x8B, 0xF9, 0x00, 0x98, 0x40, 0x0E, 0x65, 0x05, 0x66, 0xF2, 0x2A, 0x5F, 0x6C, 0x8C, 0xDD,
                0x21, 0xEB, 0x2A, 0xA8, 0xC8, 0x02, 0xA9, 0xE1, 0xF1, 0x3A, 0x61, 0xE0, 0x31, 0x3E, 0xBD, 0x77,
            },
            {
                0x23, 0x48, 0x16, 0xD2, 0xD0, 0x63, 0xEE, 0xD8, 0x23, 0x8A, 0x72, 0xB9, 0xFA, 0x48, 0xB3, 0x9F,
                0x86, 0xF7, 0x21, 0xD4, 0x4A, 0xAA, 0xF7, 0xC1, 0xAD, 0x50, 0xEF, 0x0B, 0xFF, 0x03, 0xB5, 0x58,
            }
        }
    },
    {
        "mov.paz", 32, 0,
        {
            {
                0x68, 0x77, 0x3E, 0xAC, 0x08, 0x09, 0x63, 0x42, 0xC6, 0xA9, 0xED, 0x95, 0x84, 0x4F, 0x6F, 0xC1, 
                0x6A, 0x0F, 0xC7, 0x2F, 0x10, 0xE8, 0x7E, 0x14, 0xB0, 0xD3, 0xF5, 0xA1, 0x1C, 0xA1, 0x4E, 0x7B,
            },
            {
                
            }
        }
    },
    {
        "voice.paz", 32, 0,
        {
            {
                0x0A, 0xFD, 0x6C, 0xFE, 0x6E, 0xCB, 0x20, 0xBD, 0xFC, 0x42, 0xF2, 0x5A, 0x2C, 0x97, 0x5A, 0xCB,
                0x9F, 0x22, 0xF2, 0x8E, 0xD0, 0x00, 0x3C, 0xE4, 0xE9, 0x90, 0x09, 0xD6, 0xA3, 0xDD, 0xCE, 0x8A,
            },
            {
                0x23, 0xCB, 0xE6, 0x94, 0x46, 0x69, 0x9C, 0x63, 0xE2, 0xB9, 0x12, 0xBC, 0x77, 0x8D, 0xC7, 0xEA,
                0x69, 0x41, 0xF9, 0x82, 0x7A, 0x5D, 0xC2, 0x3D, 0x2D, 0xDA, 0x94, 0x40, 0x06, 0x8B, 0xC8, 0x98,
            }
        }
    },
    {
        "se.paz", 32, 0,
        {
            {
                0x58, 0x2E, 0xF5, 0xD6, 0xEE, 0x5F, 0xEB, 0xAF, 0x0C, 0x62, 0xD8, 0x04, 0x7F, 0x7C, 0x3A, 0x6F,
                0xC1, 0xDB, 0xB9, 0xFF, 0x02, 0x01, 0x91, 0xA0, 0x62, 0xC2, 0xB6, 0xC0, 0x00, 0xE2, 0x0E, 0x0B,
            },
            {
                0xFB, 0x9C, 0xDF, 0x4B, 0xFD, 0x3D, 0xE6, 0xF1, 0xED, 0x04, 0x31, 0x4C, 0xA3, 0x1F, 0x7A, 0xD7, 
                0x73, 0xF5, 0x39, 0x4D, 0x0A, 0x5E, 0x2C, 0x42, 0x93, 0x7F, 0x16, 0x4E, 0xE4, 0x2C, 0x7B, 0xE5,
            }
        }
    },
    {
        "sys.paz", 32, 0,
        {
            {
                0xF7, 0x05, 0x7C, 0xDB, 0x71, 0x18, 0xE6, 0x65, 0xDB, 0x25, 0x13, 0x60, 0x40, 0xDE, 0x8B, 0xDC,
                0xE4, 0x56, 0x55, 0x01, 0xC1, 0x0F, 0x36, 0x48, 0xF5, 0x68, 0xEF, 0x0E, 0x53, 0x17, 0x39, 0x21,
            },
            {
                0xCB, 0xE6, 0x95, 0xCF, 0x46, 0x5E, 0x6C, 0x56, 0x0E, 0xA3, 0xE7, 0x2F, 0x16, 0xDE, 0xE4, 0x8D,
                0xA9, 0x35, 0x2C, 0xB1, 0x89, 0x72, 0x7B, 0xCA, 0x8D, 0xB7, 0x4A, 0xA0, 0x9C, 0xED, 0x4E, 0x89,
            }
        }
    },
    {
        "sys_sc.paz", 32, 0,
        {
            {
                0xF7, 0x05, 0x7C, 0xDB, 0x71, 0x18, 0xE6, 0x65, 0xDB, 0x25, 0x13, 0x60, 0x40, 0xDE, 0x8B, 0xDC,
                0xE4, 0x56, 0x55, 0x01, 0xC1, 0x0F, 0x36, 0x48, 0xF5, 0x68, 0xEF, 0x0E, 0x53, 0x17, 0x39, 0x21,
            },
            {
                0xCB, 0xE6, 0x95, 0xCF, 0x46, 0x5E, 0x6C, 0x56, 0x0E, 0xA3, 0xE7, 0x2F, 0x16, 0xDE, 0xE4, 0x8D,
                0xA9, 0x35, 0x2C, 0xB1, 0x89, 0x72, 0x7B, 0xCA, 0x8D, 0xB7, 0x4A, 0xA0, 0x9C, 0xED, 0x4E, 0x89,
            }
        }
    },
    {
        "PMscr.paz", 32, 0,
        {
            {
                0xC6, 0xB7, 0x4C, 0x01, 0x30, 0xB1, 0x17, 0x98, 0x50, 0x34, 0x51, 0x2E, 0x83, 0x8A, 0xE0, 0xD6,
                0x5A, 0xA4, 0x17, 0x67, 0x1C, 0x84, 0x1F, 0x67, 0x59, 0xA9, 0xA3, 0x95, 0x92, 0x13, 0x03, 0x7D,
            },
            {
                0x38, 0xC8, 0xF4, 0x79, 0xB6, 0x2B, 0x98, 0x69, 0x9F, 0x99, 0x86, 0x5F, 0x27, 0xDD, 0xF2, 0x70,
                0x90, 0x20, 0x2B, 0x14, 0x9F, 0x1E, 0xA3, 0xEA, 0x1B, 0x19, 0x0E, 0x64, 0x48, 0x78, 0x45, 0x33,
            }
        }
    },
    {
        "PMbg_sc.paz", 32, 0,
        {
            {
                0xC8, 0xF3, 0x9F, 0x66, 0xE6, 0xDE, 0x75, 0x86, 0x8B, 0x5B, 0x44, 0xED, 0x0D, 0x17, 0x5F, 0x62,
                0x11, 0x49, 0xBC, 0x7D, 0x67, 0x16, 0xEF, 0x26, 0xEC, 0x13, 0x56, 0x8F, 0x69, 0xA1, 0x0A, 0x7A,
            },
            {
                0x0B, 0x2E, 0x56, 0x10, 0x17, 0x2A, 0x2B, 0xB0, 0x83, 0xF8, 0xDA, 0x93, 0x90, 0x70, 0x5C, 0x99,
                0x86, 0xE7, 0xE2, 0xFC, 0xC7, 0xFF, 0xD5, 0x81, 0x1D, 0x1D, 0x03, 0x45, 0x25, 0x67, 0xFB, 0x2A,
            }
        }
    },
    {
        "PMsys_sc.paz", 32, 0,
        {
            {
                0x1F, 0xB2, 0xAF, 0xAF, 0x16, 0xC4, 0x22, 0xEF, 0x8C, 0x0A, 0xC6, 0xCD, 0xA4, 0x7F, 0xA3, 0xD9,
                0x35, 0x67, 0x64, 0x41, 0x3A, 0x27, 0xA4, 0x55, 0x24, 0xC8, 0x65, 0xB6, 0x0D, 0xC0, 0x19, 0x8D,
            },
            {
                0x1C, 0xBA, 0x7D, 0xA5, 0x05, 0xFC, 0xF0, 0xA7, 0x93, 0x0B, 0x8A, 0x66, 0x41, 0x44, 0xF9, 0x98,
                0x18, 0x3F, 0xB0, 0x11, 0xD2, 0x08, 0x87, 0xA4, 0xDF, 0xED, 0x81, 0x24, 0xCD, 0x17, 0x1A, 0x46,
            }
        }
    },
    {
        "PMbgm_sc.paz", 32, 0,
        {
            {
                0x67, 0xDC, 0xE6, 0x27, 0xCD, 0x51, 0x50, 0x29, 0x87, 0xA6, 0x55, 0x56, 0xDB, 0x88, 0x91, 0x07,
                0x6B, 0x30, 0x19, 0x1C, 0x3E, 0x5E, 0x04, 0x9E, 0x24, 0x7C, 0x3F, 0xDA, 0xA7, 0x00, 0x00, 0xE0,
            },
            {
                0x81, 0x8D, 0x1F, 0xE7, 0xB0, 0x79, 0xCA, 0xDE, 0x77, 0x50, 0x08, 0xB9, 0x47, 0x03, 0x49, 0x61,
                0x9B, 0xF2, 0x1B, 0xCF, 0xE2, 0x00, 0xE3, 0xE5, 0x58, 0x01, 0xE1, 0xB9, 0xF1, 0xC1, 0x83, 0xC2,
            }
        }
    },
    {
        "PMvoice_sc.paz", 32, 0,
        {
            {
                0xD8, 0xA3, 0xD6, 0xD1, 0x09, 0xDB, 0xB5, 0x24, 0x52, 0xF1, 0x3E, 0xD4, 0x19, 0xC3, 0x3C, 0xB3, 
                0xA8, 0xA4, 0x20, 0x77, 0x1D, 0x7F, 0xF0, 0xC3, 0x3C, 0xFD, 0x15, 0x70, 0x2A, 0xAD, 0xA3, 0x67,
            },
            {
                0x7B, 0x69, 0xC0, 0x0C, 0x6B, 0xB8, 0xFC, 0x6C, 0x36, 0x71, 0x45, 0x8F, 0x5A, 0xA1, 0x30, 0x88, 
                0x20, 0xE6, 0x34, 0xD6, 0xDF, 0x16, 0xD1, 0x0A, 0x2D, 0x28, 0xE8, 0x85, 0xD1, 0x9D, 0x6C, 0x0B,
            }
        }
    },
    {
        "PMse.paz", 32, 0,
        {
            {
                0xBD, 0xE7, 0xCB, 0x42, 0x40, 0xE6, 0x46, 0xF3, 0x5A, 0xC8, 0x32, 0x69, 0xED, 0x90, 0x13, 0x6E, 
                0x63, 0x4D, 0xE7, 0x76, 0xC9, 0x66, 0x53, 0xA6, 0x0D, 0xC8, 0xF3, 0xB0, 0xBC, 0xB0, 0xEC, 0x01,
            },
            {
                0x6B, 0xC1, 0xAB, 0xBC, 0x75, 0xD2, 0x85, 0xF0, 0xC1, 0xC3, 0x06, 0xBB, 0x91, 0x6C, 0x00, 0xF9, 
                0x59, 0xD3, 0x48, 0xC2, 0x4E, 0x5E, 0x14, 0x28, 0xC8, 0x86, 0x47, 0xE6, 0x5C, 0xCE, 0xCB, 0xD6,
            }
        }
    },
    {
        "PMmov.paz", 32, 0,
        {
            {
                0xA8, 0xD6, 0x3E, 0xAF, 0xA8, 0xEB, 0x3C, 0xD3, 0x03, 0x91, 0x7E, 0x38, 0x2F, 0x15, 0x3D, 0xEB,
                0x71, 0xE4, 0xA5, 0x5B, 0xD4, 0x55, 0x70, 0xFB, 0x9D, 0x48, 0xE6, 0x73, 0xBC, 0xA1, 0x6D, 0x7E,
            },
            {
                
            }
        }
    },
    {0, 0, 0, 0}
};

static struct PazPackKey BlowFishKey_ef_first_Pack[] = {
    {
        "scr.paz", 32, 0,
        {
            {
                0xEC, 0xA1, 0x5A, 0x7A, 0xD0, 0x79, 0x7A, 0xFF, 0x06, 0xD4, 0x30, 0xCF, 0xB8, 0x04, 0x80, 0x37, 
                0x3E, 0x86, 0x1E, 0xB2, 0x7C, 0x08, 0x44, 0x14, 0x57, 0x42, 0x0B, 0xC8, 0x2B, 0x0C, 0xF4, 0xC7,
            },
            {
                0x2A, 0x96, 0xDA, 0xE6, 0xCF, 0xB3, 0xD5, 0x9C, 0x77, 0x57, 0x8E, 0xE3, 0x9E, 0x03, 0xE4, 0x2A, 
                0x49, 0x38, 0x2F, 0xDD, 0x12, 0x83, 0xBA, 0x7A, 0x66, 0x8A, 0x03, 0xF3, 0xAB, 0xCA, 0x8E, 0xA7,
            }
        }
    },
    {
        "bg.paz", 32, 0,
        {
            {
                0x15, 0xED, 0xC3, 0xCA, 0xC7, 0x7B, 0x6D, 0xD6, 0x38, 0xF5, 0x1A, 0x91, 0x50, 0x3D, 0x94, 0x85, 
                0x39, 0x85, 0xBE, 0x56, 0x1E, 0xA0, 0xF0, 0x1B, 0xA3, 0x1D, 0x78, 0x92, 0xD1, 0x0D, 0xB6, 0xBD,
            },
            {
                0xD6, 0x36, 0xFD, 0x61, 0xEA, 0xDD, 0x22, 0x11, 0x36, 0xD0, 0x10, 0x94, 0x67, 0x85, 0xF7, 0x84, 
                0x5A, 0xD6, 0x5F, 0x5F, 0xFD, 0xC5, 0xA1, 0xD2, 0x72, 0x7B, 0xBC, 0x6A, 0x81, 0xF6, 0x53, 0xD5,
            }
        }
    },
    {
        "st.paz", 32, 0,
        {
            {
                0x90, 0x80, 0x72, 0xD3, 0x07, 0x2E, 0x3D, 0xB9, 0x5C, 0xC8, 0x99, 0xC8, 0x12, 0xB5, 0x58, 0xA3, 
                0xC8, 0x8E, 0xB2, 0xFF, 0x5A, 0xC7, 0x8C, 0x62, 0x98, 0x65, 0xFA, 0x84, 0xD4, 0x0A, 0x9E, 0xFA,
            },
            {
                0xBC, 0x25, 0x69, 0x24, 0x43, 0x3F, 0x7B, 0x23, 0x82, 0x26, 0x3D, 0x9C, 0x7B, 0x5C, 0xD7, 0x35, 
                0x5F, 0xC6, 0x26, 0xC3, 0x66, 0xF6, 0x48, 0x14, 0x37, 0x6C, 0x6C, 0xF8, 0xEA, 0x73, 0x36, 0x93,
            }
        }
    },
    {
        "sys.paz", 32, 0,
        {
            {
                0x13, 0x29, 0x55, 0x49, 0xBB, 0x67, 0x35, 0x17, 0xD3, 0x43, 0x4F, 0x47, 0xEE, 0x5E, 0x64, 0x14, 
                0x4E, 0x03, 0x8A, 0x12, 0x1F, 0xED, 0x0E, 0xBF, 0x62, 0x6D, 0x96, 0xF7, 0xCE, 0xD9, 0xF0, 0x30,
            },
            {
                0x6C, 0xAA, 0x90, 0x3D, 0x57, 0x25, 0x57, 0x99, 0xEB, 0x65, 0xC5, 0xCF, 0xB1, 0xB9, 0xE2, 0x27, 
                0x7A, 0xF1, 0x30, 0x93, 0xBD, 0xEF, 0xE9, 0x79, 0xAF, 0x5D, 0xAC, 0x91, 0xBE, 0xD0, 0x53, 0x15,
            }
        }
    },
    {
        "bgm.paz", 32, 0,
        {
            {
                0xF6, 0x69, 0xD5, 0xA1, 0x0E, 0x21, 0xCC, 0xA0, 0x18, 0x63, 0xC3, 0xB3, 0x43, 0xDF, 0xCF, 0x0F,
                0xE3, 0x14, 0x27, 0xC6, 0x55, 0x7B, 0x9F, 0xD4, 0x78, 0xEB, 0x3C, 0x5B, 0x1F, 0x9F, 0x6D, 0xB6,
            },
            {
                0x6B, 0x99, 0xAD, 0x59, 0xCF, 0xB0, 0xED, 0x3D, 0x3D, 0x83, 0xE1, 0x08, 0xD7, 0x8E, 0xD3, 0x3C,
                0xA2, 0x22, 0x0E, 0x01, 0x23, 0x71, 0x00, 0x59, 0x8B, 0x83, 0xCF, 0x77, 0x6B, 0x97, 0x45, 0xCE,
            }
        }
    },
    {
        "voice.paz", 32, 0,
        {
            {
                0x22, 0xBF, 0x45, 0xD9, 0x43, 0x0A, 0xEF, 0x7D, 0xBA, 0x3D, 0x95, 0x5D, 0x42, 0xAF, 0x39, 0x90, 
                0x0B, 0xC2, 0x4C, 0x8C, 0x72, 0x0D, 0x08, 0x81, 0x08, 0x5A, 0x30, 0x64, 0xC7, 0x0B, 0x8F, 0x8D,
            },
            {
                0xA1, 0x3B, 0xBA, 0x88, 0x3A, 0xA3, 0xDD, 0x0C, 0x30, 0x92, 0xA8, 0xAD, 0xFE, 0x25, 0x80, 0x14, 
                0xCD, 0x5B, 0x0D, 0x57, 0x9D, 0x8A, 0x21, 0x9C, 0xED, 0x2D, 0xB8, 0xD6, 0x82, 0x32, 0x0D, 0x3A,
            }
        }
    },
    {
        "se.paz", 32, 0,
        {
            {
                0x73, 0x9E, 0xB8, 0xFD, 0x20, 0x1A, 0x9C, 0xFC, 0x1B, 0x2D, 0x44, 0x83, 0x15, 0x3C, 0x06, 0x65, 
                0x79, 0x88, 0x8C, 0xCD, 0x75, 0x26, 0xB3, 0xE5, 0x9C, 0x35, 0x60, 0x85, 0x98, 0x14, 0x90, 0x53,
            },
            {
                0xCC, 0x17, 0x29, 0x26, 0x10, 0xA9, 0x20, 0x18, 0x17, 0xB8, 0xDD, 0xF0, 0xD2, 0x62, 0xCD, 0x44, 
                0x53, 0xCE, 0x38, 0x98, 0x81, 0xB6, 0xB4, 0x31, 0x3F, 0x08, 0x1C, 0xA0, 0xAA, 0xF3, 0x86, 0x6E,
            }
        }
    },
    {
        "mov.paz", 32, 0,
        {
            {
                0x75, 0xE3, 0xE5, 0x40, 0xC9, 0x5B, 0x77, 0x17, 0x34, 0x4A, 0xD9, 0xC7, 0x12, 0xE3, 0x5A, 0xBB, 
                0x31, 0x60, 0x8D, 0xDB, 0x04, 0x57, 0xFD, 0xC2, 0x95, 0xC4, 0x0A, 0x7A, 0x14, 0xB5, 0xC0, 0x08,
            },
            {
                
            }
        }
    },
    {0, 0, 0, 0}
};

static struct PazPackKey BlowFishKey_mashiroiro_Pack[] = {
    {
        "bg.dat", 32, 0,
        {
            {
                0xDA, 0xF4, 0xC6, 0xB6, 0xF6, 0x36, 0xE0, 0x1D, 0x6C, 0x01, 0x0A, 0xD4, 0x0D, 0xBD, 0x5C, 0xC4, 
                0xF6, 0x1E, 0x27, 0xFD, 0x9E, 0x3A, 0x1C, 0x48, 0x44, 0x88, 0xFC, 0x44, 0x16, 0x3E, 0x8E, 0x61
            },
            {
                0x80, 0x2E, 0xBD, 0xF5, 0x15, 0x41, 0xBF, 0xE4, 0xD9, 0x89, 0x0F, 0x0B, 0x20, 0xB3, 0x7A, 0xCE, 
                0x44, 0x28, 0x78, 0xAA, 0x2E, 0x9B, 0x9B, 0x83, 0x50, 0x3B, 0x49, 0x58, 0xFC, 0x27, 0x9A, 0x3B
            }
        }
    },
    {
        "bgm.dat", 32, 0,
        {
            {
                0x59, 0xBA, 0xC5, 0xD6, 0x7B, 0xA9, 0x3D, 0x7E, 0x58, 0xB1, 0x24, 0x43, 0xB0, 0x9D, 0x3F, 0x8E, 
                0x96, 0xF3, 0x01, 0x82, 0x87, 0xCB, 0x97, 0xA3, 0x58, 0x1C, 0xDD, 0xC5, 0x71, 0xAA, 0x5E, 0x16
            },
            {
                0xBE, 0xC8, 0xF3, 0xAF, 0xEF, 0x19, 0x7E, 0xF8, 0x1F, 0xB9, 0x74, 0xF6, 0xC1, 0x71, 0x3B, 0x97, 
                0xB6, 0x02, 0xDF, 0x80, 0xBD, 0x0D, 0x5E, 0x62, 0xED, 0x30, 0x7C, 0x2B, 0x95, 0xAD, 0x7E, 0x72
            }
        }
    },
    {
        "scr.dat", 32, 0,
        {
            {
                0x0C, 0xDD, 0x58, 0x3C, 0x5D, 0xDE, 0x0A, 0x03, 0x07, 0x8A, 0x3D, 0xBA, 0x8C, 0x4A, 0xCC, 0x19, 
                0x8B, 0x80, 0xD3, 0xC8, 0xD4, 0xFA, 0x56, 0xF0, 0x7B, 0x24, 0x31, 0xF4, 0x17, 0x79, 0x1A, 0x12
            },
            {
                0x7B, 0x5B, 0xD5, 0x46, 0x31, 0x77, 0xC3, 0x5B, 0x4F, 0x26, 0xE6, 0xDC, 0x5F, 0x2C, 0xA8, 0xDC, 
                0xC1, 0xB8, 0xAC, 0x13, 0x14, 0x4E, 0x3C, 0x51, 0x22, 0x33, 0x27, 0x9A, 0x49, 0xAF, 0x4C, 0xD6
            }
        }
    },
    {
        "se.dat", 32, 0,
        {
            {
                0x9E, 0xBB, 0x21, 0x17, 0x88, 0xF1, 0x52, 0x26, 0xE0, 0x36, 0x18, 0x3E, 0x0E, 0xE5, 0x21, 0xE6, 
                0xB0, 0x25, 0xF1, 0x1C, 0xD4, 0x14, 0xE4, 0x35, 0xF0, 0xF6, 0x7D, 0x85, 0x17, 0x1B, 0xE7, 0x87
            },
            {
                0xBD, 0x7C, 0x7A, 0x3B, 0x9B, 0xAD, 0xF5, 0x4E, 0xB0, 0x12, 0x38, 0x5A, 0xB4, 0x33, 0x37, 0xE9, 
                0x1B, 0xFB, 0xD3, 0x5D, 0x52, 0x43, 0x37, 0x24, 0xF4, 0x97, 0xE5, 0xFC, 0x17, 0x6D, 0x9F, 0xA4
            }
        }
    },
    {
        "st.dat", 32, 0,
        {
            {
                0x9B, 0xE0, 0xD0, 0x5D, 0xB0, 0x19, 0x52, 0xE1, 0xA3, 0x23, 0x76, 0x77, 0x75, 0x14, 0x2C, 0x70, 
                0x72, 0x03, 0xDE, 0x8A, 0x95, 0xB8, 0xC5, 0x72, 0x7F, 0xB2, 0xB8, 0x69, 0x83, 0x4F, 0x07, 0xF5
            },
            {
                0xF3, 0x56, 0x86, 0x62, 0x33, 0x5F, 0x1A, 0xFE, 0x6E, 0xEE, 0x1F, 0x2F, 0x64, 0x2A, 0xC4, 0x32, 
                0x4D, 0xA1, 0x6A, 0xED, 0x09, 0x63, 0x0A, 0x2F, 0xC3, 0xA0, 0x87, 0x3D, 0x78, 0xDF, 0xF5, 0x10
            }
        }
    },
    {
        "sys.dat", 32, 0,
        {
            {
                0x54, 0xBC, 0x99, 0x76, 0xC4, 0x6D, 0x0A, 0x37, 0x87, 0x21, 0xD7, 0x14, 0x7C, 0xAE, 0xB6, 0xD4, 
                0x3E, 0x6F, 0x61, 0x77, 0x40, 0x15, 0x2B, 0x81, 0xD4, 0xA0, 0x0F, 0xFE, 0x40, 0xA7, 0x9B, 0x1F
            },
            {
                0x86, 0xE3, 0xF5, 0x42, 0x60, 0xE9, 0xB2, 0xA2, 0x2D, 0x21, 0x53, 0x63, 0xFB, 0x55, 0xE5, 0x55, 
                0x98, 0x84, 0x86, 0xE6, 0xF9, 0x66, 0x1A, 0xA1, 0x68, 0x41, 0x39, 0xC5, 0x2D, 0xFC, 0x0F, 0x45
            }
        }
    },
    {
        "voice.dat", 32, 0,
        {
            {
                0x18, 0x0F, 0x6D, 0xF7, 0x6C, 0xB9, 0x00, 0x74, 0x89, 0x4C, 0xC5, 0x46, 0x8C, 0x1C, 0x0B, 0x9D, 
                0x49, 0xC7, 0xD2, 0x99, 0xDF, 0x2A, 0x73, 0xEA, 0xD8, 0x20, 0xAF, 0x67, 0x91, 0x69, 0x80, 0x68
            },
            {
                0xC0, 0x60, 0xDF, 0xF7, 0x4D, 0x4C, 0x09, 0xB3, 0x3C, 0xE6, 0x07, 0x53, 0x3D, 0xFD, 0xD8, 0x2E, 
                0x33, 0x9F, 0x49, 0x66, 0x1E, 0x9B, 0x0B, 0xF6, 0xB2, 0x64, 0x18, 0x3E, 0xC4, 0x38, 0x6A, 0xDB
            }
        }
    },
    {
        "mov.dat", 32, 0,
        {
            {
                0x82, 0x1F, 0x90, 0xFA, 0xF7, 0x68, 0xCA, 0xB0, 0x30, 0x52, 0x2C, 0x79, 0xE2, 0x37, 0xDD, 0x14, 
                0x5C, 0x8E, 0xF5, 0x9D, 0x31, 0xD2, 0x30, 0xF0, 0x1D, 0x0A, 0x84, 0xAA, 0xA6, 0x27, 0xB8, 0xD1
            },
            {
                
            }
        }
    },

    {0, 0, 0, 0}
};

static GAMEDECRYPTINFO BlowFishKey_ef_first = {
    "ef_first", 0x7f, 0, vector<HANDLE>(), {0, 0, 0, 0}, BlowFishKey_ef_first_Pack
};

static GAMEDECRYPTINFO BlowFishKey_ef_latter = {
    "ef_latter", 0x7f, 1, vector<HANDLE>(), {"A00U43Mj", "957277W1", "m24lX440", "8fO1Xj6g"}, BlowFishKey_ef_latter_Pack
};

static GAMEDECRYPTINFO BlowFishKey_eden = {
    "eden_main", 0xaa, 1, vector<HANDLE>(), {"N426Fd94", "p37j344s", "ol0lOrAf", "Uyiu4Ruy"}, BlowFishKey_eden_Pack
};

static GAMEDECRYPTINFO BlowFishKey_effd = {
    "ef_fd", 0x0, 1, vector<HANDLE>(), {"31t2Edk4", "umTkCwX7", "G4YS36o7", "97Hy2gfd"}, BlowFishKey_effd_Pack
};  // 下不到原版，解的是汉化版的封包，大部分无需异或，但仍有部分文件需要异或0xAA，提取不了就改为0xAA即可，纯白同

static GAMEDECRYPTINFO BlowFishKey_sppl1 = {
    "sppl1", 0x7f, 2, vector<HANDLE>(), {"gTcL74ch", "36TXHE5N", "oRQCAU1o", "hYPH3Fxw"}, BlowFishKey_sppl1_Pack
};

static GAMEDECRYPTINFO BlowFishKey_12eve = {
    "12eve", 0xe1, 2, vector<HANDLE>(), {"tv5Qxea1", "5pNKE7Au", "Aow5oJ45", "5Lgv7XCh"}, BlowFishKey_12eve_Pack
};

static GAMEDECRYPTINFO BlowFishKey_mashiroiro = {
    "mashiroiro", 0x0, 1, vector<HANDLE>(), {"rytKRa38", "hFx1Bh93", "cQ5jhgpb", "ChFdc6iA"}, BlowFishKey_mashiroiro_Pack
};

static GAMEDECRYPTINFO BlowFishKeyArray [] = {  // 按使用说明中的顺序排列
    BlowFishKey_ef_first,
    BlowFishKey_ef_latter,
    BlowFishKey_eden,
    BlowFishKey_effd,
    BlowFishKey_sppl1,
    BlowFishKey_12eve,
    BlowFishKey_mashiroiro,

};


struct ef_latter_crypt {
    BYTE seed[2];
    BYTE stage[256];
};

static BYTE PazMovDecryptTableSeed[256];
static BYTE PazMovDecryptTable[256][256];


static int PazReadXor(HANDLE hFile, PVOID Buffer, DWORD Len, BYTE xor)
{
    DWORD R;

    int ret = ReadFile(hFile, Buffer, Len, &R, 0);
    ret &= (Len == R);

    for (DWORD i=0; i<Len; ++i)
        *((PBYTE)Buffer + i) ^= xor;

    return ret;
}

static void PazDecrypt(PDWORD cipher, DWORD cipherLength, PBYTE key, int keyLen)
{
    BLOWFISH_CTX ctx;
    DWORD i;

    Blowfish_Init(&ctx, key, keyLen);
    for (i = 0; i < cipherLength / 8; i++)
        Blowfish_Decrypt(&ctx, &cipher[i * 2 + 0], &cipher[i * 2 + 1]);
}


// 封包匹配函数
// 返回0: OK
static int MusicaPazMatch(struct PazPackKey *pCurPaz)
{
    if (!pCurPaz || !pCurPaz->parent->PackList.size())
        return -1;

    int ret = -1;
    HANDLE hPack = pCurPaz->parent->PackList[0];

    do
    {
        if (!strcmp(pCurPaz->parent->Name, "ef_fd") ||
            !strcmp(pCurPaz->parent->Name, "eden_main"))
        {
            ret = 0;
            break;
        }
        
        PAZHEADER header;
        DWORD R;

        SetFilePointer(hPack, 0, 0, FILE_BEGIN);
        ReadFile(hPack, &header, sizeof(header), &R, 0);

        if (!strcmp(pCurPaz->parent->Name, (char*)header.Byte))
            ret = 0;
        else
        {
            for (int i=0; i<sizeof(header); ++i)
                header.Byte[i] ^= pCurPaz->parent->XorCode;

            ret = strcmp(pCurPaz->parent->Name, (char*)header.Byte);
        }
    } while (0);

    return ret;
}


static void Generic_ef_first_key(PBYTE key, int len)
{
    static char *xor = "minori";
    for (int i=0; i<len; ++i)
    {
        *key ^= *(PBYTE)(xor + i%6);
        *key++ = -(*key);
    }
}


// 封包索引提取函数
// 返回0: OK
static int MusicaPazExtractIndex(struct PazPackKey *pCurPaz, vector<MYPAZENTRY>& Index)
{
    if (!pCurPaz || pCurPaz->parent->PackList.empty())
        return -1;

    if (!Index.empty())
        Index.clear();

    HANDLE hPack = pCurPaz->parent->PackList[0];
    PPAZENTRY entry = 0;
    DWORD idxLength = 0;
    SetFilePointer(hPack, sizeof(PAZHEADER), 0, FILE_BEGIN);
    PazReadXor(hPack, &idxLength, 4, pCurPaz->parent->XorCode);

    if (!idxLength ||
        !(entry = (PPAZENTRY)VirtualAlloc(NULL, idxLength, MEM_COMMIT, PAGE_READWRITE)))
    {
        printf("MusicaPazExtractIndex 中索引长度为0或内存分配失败\n");
        if (entry) VirtualFree(entry, 0, MEM_RELEASE);
        return 1;
    }

    PazReadXor(hPack, entry, idxLength, pCurPaz->parent->XorCode);
    if (idxLength & 7)    // 8字节对齐
    {
        printf("MusicaPazExtractIndex: 索引长度没有对齐\n");
        VirtualFree(entry, 0, MEM_RELEASE);
        return 2;
    }

    // ef-first 的key特殊处理一下, 虽然也可以直接保存结果避免计算
    if (!strcmp(pCurPaz->parent->Name, "ef_first"))
        Generic_ef_first_key(pCurPaz->Key[0], pCurPaz->KeyLen);

    PazDecrypt((PDWORD)entry, idxLength, pCurPaz->Key[0], pCurPaz->KeyLen);
    
    MYPAZENTRY myEntry;
    DWORD entryNum = 0;
    entryNum = *(PDWORD)entry;
    if (!strncmp(pCurPaz->PazName, "mov", 3))
    {
        if (!strcmp(pCurPaz->parent->Name, "ef_first"))
        {
            PBYTE p = (PBYTE)entry + 4;
            for (int j = 0; j < 256; ++j)
                for (int k = 0; k < 256; ++k)
                    for (int n = 255; n >= 0; --n)
                        if (p[n] == k)
                            PazMovDecryptTable[j][k] = n;

            entry  = (PPAZENTRY)((PBYTE)entry + 65536);
        }
        else
        {
            memcpy(PazMovDecryptTableSeed, (PBYTE)entry+4, 256);
            entry  = (PPAZENTRY)((PBYTE)entry + 256);
        }
    }

    for (PBYTE p = (PBYTE)entry + 4; entryNum-- && p<(PBYTE)entry+idxLength-4; )
    {
        memset(&myEntry, 0, sizeof(myEntry));
        strcpy_s(myEntry.Name, MAX_PATH-1, (char*)p);
        p += strlen((char*)p) + 1;
        myEntry.Offset.QuadPart = *(PLONG64)p;
        p += 8;
        myEntry.UncomprLen = *(PDWORD)p;
        p += 4;
        myEntry.ComprLen = *(PDWORD)p;
        p += 4;
        myEntry.AlignPkgLen = *(PDWORD)p;
        p += 4;
        myEntry.IsCompressed = *(PWORD)p;
        p += 2;
        myEntry.Reserved = *(PWORD)p;
        p += 2;

        Index.push_back(myEntry);
    }

    return 0;
}


// 封包资源保存函数
// 返回0: OK
static int MusicaPazSaveResource(const PBYTE data, DWORD length, const char *name, const char *dir)
{
    if (!data || !length || !name)
        return 1;

    int dirlen = strlen(dir);
    char FullName[MAX_PATH];
    strcpy_s(FullName, MAX_PATH-1, dir);
    strcat_s(FullName, MAX_PATH-1, "\\");
    strcat_s(FullName, MAX_PATH-1, name);
    for (int i=dirlen; FullName[i]; ++i)
        if (FullName[i] == '\\')
        {
            FullName[i] = 0;
            CreateDirectoryA(FullName, 0);
            FullName[i] = '\\';
        }

    HANDLE hSave = CreateFileA(FullName, GENERIC_WRITE, FILE_SHARE_READ, 0, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);
    if (INVALID_HANDLE_VALUE == hSave)
        return 2;
    
    DWORD BytesWritten;
    int ret = !(WriteFile(hSave, data, length, &BytesWritten, 0)
        && (BytesWritten == length));

    CloseHandle(hSave);
    return ret;
}


static BYTE ef_latter_decrypt_rand(struct ef_latter_crypt *crypt)
{
    BYTE BL, DL;
    ++crypt->seed[0];
    DL = crypt->stage[crypt->seed[0]];
    crypt->seed[1] += DL;
    BL = crypt->stage[crypt->seed[1]];
    crypt->stage[crypt->seed[1]] = DL;
    crypt->stage[crypt->seed[0]] = BL;
    BL += DL;
    return crypt->stage[BL];
}


static void ef_latter_decrypt_init(struct ef_latter_crypt *crypt,
                                   char *key_string, DWORD key_length)
{
    if (!key_length)
        key_length = strlen(key_string);

    crypt->seed[0] = 0;
    crypt->seed[1] = 0;
    for (DWORD i = 0; i < 256; ++i)
        crypt->stage[i] = (BYTE)i;

    DWORD j = 0;
    BYTE idx = 0;
    for (int i = 0; i < 256; ++i)
    {
        BYTE tmp = crypt->stage[i];
        idx += tmp + key_string[j++];
        crypt->stage[i] = crypt->stage[idx];
        crypt->stage[idx] = tmp;
        if (j >= key_length)
            j = 0;
    }
}


static void ef_latter_decrypt_data(const char *id, BYTE *enc, DWORD enc_length, const char *key_string)
{
    struct ef_latter_crypt crypt;
    char init_key = 0;
    char dec_string[256];

    ef_latter_decrypt_init(&crypt, &init_key, 1);
    int len = sprintf_s(dec_string, 255, "%s %08X %s", key_string, enc_length, id);
    for (int i=0; i<len && dec_string[i]!=' '; ++i)
        dec_string[i] = tolower(dec_string[i]);
    
    ef_latter_decrypt_init(&crypt, dec_string, 0);
    for (DWORD i = 0; i < enc_length; ++i)
        enc[i] ^= ef_latter_decrypt_rand(&crypt);
}



static void MusicaPazDecryptStageII_Ver1(PBYTE rawData, DWORD rawDataLen,
    const char *filename, struct PazPackKey *pcurpaz)
{
    if (!rawData || !rawDataLen || !pcurpaz || !filename)
        return;

    const char *key = 0, *packname = pcurpaz->PazName;
    const char *gamename = pcurpaz->parent->Name;

    int k = strlen(filename);
    while (k>0 && filename[k-1] != '.') --k;
    
    if (!strcmp(&filename[k], "png"))
        key = pcurpaz->parent->secret[pcurpaz->parent->TYPE_PNG];
    else if (!strcmp(&filename[k], "sc"))
        key = pcurpaz->parent->secret[pcurpaz->parent->TYPE_SCR];
    else if (!strcmp(&filename[k], "ogg") || !strncmp(packname, "voice", 5) || !strncmp(packname, "PMvoice", 5))
        key = pcurpaz->parent->secret[pcurpaz->parent->TYPE_OGG];
    else return;

    ef_latter_decrypt_data(key, rawData, rawDataLen, filename);
}


static void MusicaPazDecryptStageII_Ver2(PBYTE rawData, DWORD rawDataLen, PMYPAZENTRY pEntry, struct PazPackKey *pcurpaz)
{
    if (!rawData || !rawDataLen || !pcurpaz)
        return;

    int type;
    string filename = string(pEntry->Name);

    if (filename.find(".sc") != string::npos)
        type = 0;
    else if (filename.find(".png") != string::npos)
        type = 1;
    else if (filename.find(".ogg") != string::npos || !strcmp(pcurpaz->PazName, "voice.paz"))
        type = 2;
/*    else if (filename.find(".avi") != string::npos || filename.find(".mpg") != string::npos)
        type = 3;*/
    else
    {
        printf("MusicaPazDecryptStageII_Ver2: 未知的数据文件类型: %s\n", pEntry->Name);
        return;
    }


    BYTE array1[256] = {0};

    for (DWORD i = 0; i < 256; i++)
        array1[i] = (BYTE)i;
    
    // 文件名要先转为小写字母
    for (char *p=pEntry->Name; *p; ++p)
        *p = tolower(*p);

    char KeyStr[256];
    int KeyStrLen = sprintf_s(KeyStr, 255, "%s %08X %s", pEntry->Name, rawDataLen, pcurpaz->parent->secret[type]);
    BYTE index   = 0;

    struct ef_latter_crypt crypt;
    ef_latter_decrypt_init(&crypt, KeyStr, KeyStrLen);

    for (DWORD i = 0; i < 256; i++)
    {
        index += array1[i] + KeyStr[i%KeyStrLen];
        std::swap(array1[i], array1[index]);
    }
    
    BYTE idx1 = 0, idx2 = 0;
    DWORD eax = 0xffffffff;        // 我已经不知道该取什么变量名了...or2=3
    for (int i=0; i<KeyStrLen; ++i)
    {
        BYTE esi = (BYTE)(KeyStr[i] ^ eax);
        eax >>= 8;
        eax ^= DecryptTable[esi];
    }

    DWORD v30 = ((~eax) >> 12) & 0xFF; 

    for (DWORD i = 0; i < v30; ++i)
    {
        ++idx1;
        idx2 += array1[idx1];
        std::swap(array1[idx1], array1[idx2]);
    }
    

    for (DWORD i=0; i<rawDataLen; ++i)
    {
        ++idx1;
        idx2 += array1[idx1];
        std::swap(array1[idx1], array1[idx2]);

        rawData[i] ^= array1[(array1[idx1] + array1[idx2]) & 0xff];
    }
}


static void CorrectFileOffset(const MYPAZENTRY& entry, struct PazPackKey *pcurpaz, PLARGE_INTEGER pli, PDWORD pidx)
{
    vector<HANDLE>& list = pcurpaz->parent->PackList;

    pli->QuadPart = 0;
    *pidx = 0;
    LARGE_INTEGER offset = entry.Offset, filesize;

    while (true)
    {
        filesize.LowPart = GetFileSize(list[*pidx], (PDWORD)&filesize.HighPart);
        if (offset.QuadPart >= filesize.QuadPart)
            offset.QuadPart -= filesize.QuadPart;
        else
            break;

        ++(*pidx);
    }

    pli->QuadPart = offset.QuadPart;
}


// 封包资源提取函数
static int MusicaPazExtractResource(struct PazPackKey *pCurPaz, vector<MYPAZENTRY>& Index)
{
    if (!pCurPaz || !pCurPaz->parent->PackList.size() || Index.empty())
        return 0;

    int extractRes = 0;
    DWORD BytesRead;
    PBYTE rawData = 0;
    DWORD rawDataLen;
    bool ef_first;

    ef_first = !strcmp(pCurPaz->parent->Name, "ef_first");

    for (DWORD i=0; i<Index.size(); ++i)
    {
        PBYTE cipher = (PBYTE)VirtualAlloc(NULL, Index[i].AlignPkgLen, MEM_COMMIT, PAGE_READWRITE);
        if (!cipher)
        {
            printf("MusicaPazExtractResource:内存分配失败, i = %d, filename: %s, length: 0x%08x\n",
                i, Index[i].Name, Index[i].AlignPkgLen);
            VirtualFree(cipher, 0, MEM_RELEASE);
            continue;
        }

        LARGE_INTEGER NewOffset;
        DWORD idx;
        CorrectFileOffset(Index[i], pCurPaz, &NewOffset, &idx);

        if (INVALID_SET_FILE_POINTER == SetFilePointer(
            pCurPaz->parent->PackList[idx], NewOffset.LowPart, &NewOffset.HighPart, FILE_BEGIN)
            || !ReadFile(pCurPaz->parent->PackList[idx], cipher, Index[i].AlignPkgLen, &BytesRead, 0))
        {
            printf("文件数据读取失败, i = %d, filename: %s\n", i, Index[i].Name);
            VirtualFree(cipher, 0, MEM_RELEASE);
            continue;
        }


        if (!strncmp(pCurPaz->PazName, "mov", 3))
        {
            if (!strcmp(pCurPaz->parent->Name, "ef_first"))
            {
                for (DWORD j=0; j<Index[i].ComprLen; ++j)//  a[][]
                    cipher[j] = *((PBYTE)PazMovDecryptTable + (((j>>16)<<8) & 0xff00) + (cipher[j]^pCurPaz->parent->XorCode));
            }
            else
            {
                char key[256];
                BYTE movTable[256];

                // sprintf_s 似乎有问题？
                DWORD keyLen = sprintf(key, "%s %08X %s", Index[i].Name, Index[i].ComprLen, pCurPaz->parent->secret[pCurPaz->parent->TYPE_MOV]);
                for (char* p=key; *p!=' '; *p++ = tolower(*p));
                    
                for (DWORD j=0; j<256; ++j)
                    movTable[j] = PazMovDecryptTableSeed[j] ^ key[j % keyLen];

                struct ef_latter_crypt crypt;
                ef_latter_decrypt_init(&crypt, (char*)movTable, 256);
                for (DWORD j=0; j<256; ++j)
                    for (DWORD k=0; k<256; ++k)
                        PazMovDecryptTable[j][k] = ef_latter_decrypt_rand(&crypt);

                PBYTE p = (PBYTE)PazMovDecryptTable;
                for (DWORD j=0; j<Index[i].ComprLen; ++j)
                    cipher[j] ^= pCurPaz->parent->XorCode ^ p[j & 0xffff];
            }
            rawData = cipher;
            rawDataLen = Index[i].ComprLen;
            goto RESSAVE;
        }


        for (DWORD j=0; j<Index[i].AlignPkgLen; ++j)
            cipher[j] ^= pCurPaz->parent->XorCode;

        if (ef_first && !strcmp(pCurPaz->parent->Name, "ef_first"))
        {
            ef_first = false;
            Generic_ef_first_key(pCurPaz->Key[1], pCurPaz->KeyLen);
        }
        PazDecrypt((PDWORD)cipher, Index[i].AlignPkgLen, pCurPaz->Key[1], pCurPaz->KeyLen);


        rawData = 0;
        rawDataLen = Index[i].UncomprLen;
        if (Index[i].IsCompressed)
        {
            bool next = true;
            do
            {
                if (!uncompress)
                    printf("zlib.dll丢失, 无法解压文件 %s", Index[i].Name);
                else
                {
                    if (!(rawData = (PBYTE)VirtualAlloc(NULL, rawDataLen, MEM_COMMIT, PAGE_READWRITE)))
                        printf("内存分配失败, i = %d, filename: %s, length: 0x%08x\n",
                            i, Index[i].Name, rawDataLen);
                    else
                    {
                        if (Z_OK == uncompress(rawData, &rawDataLen, cipher, Index[i].ComprLen)
                            || Index[i].UncomprLen != rawDataLen)
                            printf("zlib解压失败, i = %d, filename: %s\n", i, Index[i].Name);
                        else
                            break;
                    }
                }
                VirtualFree(cipher, 0, MEM_RELEASE);
                continue;

            } while (0);

            VirtualFree(cipher, 0, MEM_RELEASE);
        }
        else
            rawData = cipher;


        if (pCurPaz->parent->Version == 1)
            MusicaPazDecryptStageII_Ver1(rawData, rawDataLen, Index[i].Name, pCurPaz);

        else if (pCurPaz->parent->Version == 2)
            MusicaPazDecryptStageII_Ver2(rawData, rawDataLen, &Index[i], pCurPaz);


        if (!strcmp(pCurPaz->PazName, "voice.paz"))
            strcat_s(Index[i].Name, MAX_PATH-1, ".ogg");

RESSAVE:
        if (MusicaPazSaveResource(rawData, rawDataLen, Index[i].Name, OutputDirectory))
            printf("资源保存失败, i = %d, filename: %s\n", i, Index[i].Name);
        else
            ++extractRes;

        VirtualFree(rawData, 0, MEM_RELEASE);
    }


    return extractRes;
}


static bool GetPazPackList(const char *pazname, struct PazPackKey *pcurpaz)
{
    vector<HANDLE>& list = pcurpaz->parent->PackList;
    char name[MAX_PATH];
    HANDLE htmp;

    strcpy_s(name, MAX_PATH-1, pazname);
    int length = strlen(name);
    if (length >= MAX_PATH)
        return false;

    if (INVALID_HANDLE_VALUE == 
        (htmp = CreateFileA(name, GENERIC_READ, FILE_SHARE_READ, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0)))
        return false;

    list.push_back(htmp);
    for (char i='A'; i<='Z'; ++i)
    {
        name[length] = i;
        name[length+1] = 0;

        if (INVALID_HANDLE_VALUE == (
            htmp = CreateFileA(name, GENERIC_READ, FILE_SHARE_READ, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0)))
            break;

        list.push_back(htmp);
    }

    return true;
}


int main(int argc, char** argv)
{
    char PackName[MAX_PATH];
    
    HMODULE hZlib = LoadLibraryA("zlib.dll");
    if (hZlib)
        uncompress = (UNCOM)GetProcAddress(hZlib, "uncompress");
    
    if (!hZlib || !uncompress)
        printf("<警告: zlib.dll丢失, 将无法解压部分文件>\n");

    // 参数检查及环境设定
    if (argc == 3 || argc == 4)
    {
        strcpy_s(OutputDirectory, MAX_PATH-1, argv[2]);
        int k = strlen(OutputDirectory);
        while (k>0 && OutputDirectory[k-1] != '\\') --k;
        strcpy_s(PackName, MAX_PATH-1, &OutputDirectory[k]);

        if (argc == 3)
        {
            char dir[MAX_PATH] = "[extract] ";
            strcat_s(dir, MAX_PATH-1, &OutputDirectory[k]);
            OutputDirectory[k] = 0;
            strcat_s(OutputDirectory, MAX_PATH-1, dir);
        }
        else
        {
            strcpy_s(OutputDirectory, MAX_PATH-1, argv[3]);
        }
        
        CreateDirectoryA(OutputDirectory, 0);
    }
    else
    {
        printf(USAGE);
        return 0;
    }
    
    int GameIndex = atoi(argv[1]);
    if (GameIndex < 1 || GameIndex > GAMENUM)
    {
        printf(USAGE);
        return 0;
    }


    // 根据游戏索引及封包名设定使用的Key数据
    struct PazPackKey *pCurPaz = 0;
    for (int i=0; BlowFishKeyArray[GameIndex-1].pack[i].PazName; ++i)
    {
        if (!strcmp(PackName, BlowFishKeyArray[GameIndex-1].pack[i].PazName))
        {
            pCurPaz = &BlowFishKeyArray[GameIndex-1].pack[i];
            pCurPaz->parent = &BlowFishKeyArray[GameIndex-1];
            break;
        }
    }
    if (!pCurPaz)
    {
        printf("匹配不到当前的封包\n");
        return 0;
    }

    if (!GetPazPackList(argv[2], pCurPaz))
    {
        printf("无法打开封包文件\n");
        return 0;
    }
    
    
    vector<MYPAZENTRY> Index;

    // 检查封包文件是否合法
    if (MusicaPazMatch(pCurPaz))
    {
        printf("封包不匹配\n");
        goto CLEAN;
    }
    

    // 提取封包索引
    if (MusicaPazExtractIndex(pCurPaz, Index))
    {
        printf("封包索引提取失败\n");
        Index.clear();
        goto CLEAN;
    }


    // 提取资源
    int resNum;
    resNum = MusicaPazExtractResource(pCurPaz, Index);
    printf("提取资源%d个，共%d个，%d个提取失败\n",
        resNum, Index.size(), Index.size() - resNum);

    Index.clear();

CLEAN:
    for each(HANDLE h in pCurPaz->parent->PackList)
        CloseHandle(h);
    pCurPaz->parent->PackList.clear();



    return 0;
}